var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __values = (this && this.__values) || function(o) {
    var s = typeof Symbol === "function" && Symbol.iterator, m = s && o[s], i = 0;
    if (m) return m.call(o);
    if (o && typeof o.length === "number") return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
    throw new TypeError(s ? "Object is not iterable." : "Symbol.iterator is not defined.");
};
var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};
var getKeelaIcon = function () { return "data:image/png;base64,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"; };
var getPersonIcon = function () { return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAQAAABIkb+zAAAB50lEQVR4Ae3ZA4xcURSA4b8aB2uHdbgba6ONNs429kS7sTUx6zao7Ta2a9u2EdSj4NRczbz73pw7yfn+2I9XGGOMMcYYY0yoUgyxjws8oUiep1xkDwtIUBda2EAeGaM8G2jBa9PJ8QmZoE/kmI6nGjiOVNBxGvDQLB4iFfaQWXimmWdIFT2jDY8kOY9U2RXSeGMxEqBFeKKLAhKgAt14YQMSsI14IEYeCVieGOoGEYcGUbcWcWgd6g4hDh1C3R3EoTuo+4w49Al1HxGHPqLuLuLQXdQdQRw6Yr9RG8hifK7vqQSsRwK2AS+0BZ5Ot9b3gmYx3khyGamy8yTxSDtPq1zUN+OZ2dzX31Zx08AppILO0ICnYuTIIxOUJ0cMr7VNuLnbRl1I/rW9Xvi5vT5EAq8ZY4wxMXrJspgdHOD2X+PxZ+5wgF0sIksvMbzTyQhbuEgZqaASF9nCCJ2oizPAMq4iAbvKMgaIoaKP1XxAcO8dq+mjhpJkOYuE3FmyJIjcNIZ5g0TUa4aZRoT6uYFE3A36iUSKrUiN2kqKkHVyFalhV+kkRN08QmrcQ3oISYZ7iEL3yOifALi1FtzNQxSbj7OViGIrcXYFUewyzgqIYgWciXJ2AXYBdgF2AVFkF2CMMcYYY4wxXwDcGirAWk0QHQAAAABJRU5ErkJggg=="; };
var getLockIcon = function () { return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxMzggNzkuMTU5ODI0LCAyMDE2LzA5LzE0LTAxOjA5OjAxICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+IEmuOgAAA2FJREFUWIXFlz1sHEUUx39vZnfvfD4ftokjAlICKChKmhBAEImIIlIQFdS4QHwUCCrSgKKkikKBhBA0FHw0IIUCiiQdRKJJgfIBFLGcAoMQQUT4jCMT3+3t1wzFnc1mc7cfhyz+0kr73r597zczb2e0QkpvHVmkQHPAPPAU8BgwM/D7wA/AFeALIDfRO+f3bd47RRVTOg4cAyaHPJsCnhlcJ4DTwBtAuyipKlG4CVwETo0oPkzzwBJwqCiwzAycBx7P+OIB1J+AAVrAw8D2VEwL+BZ4EPh9XIA3gYMZ3/vAe8D1jH8CeAn4IJXXBc4Cj44qkLcELeBkxvcqcHRIceg34ofAfmAt5X+EOwdRCuAQUEvZnwEf5cRvaBF4PeN7bhyAhzL2pyWKb+gc/d7Y0BPjAGT7Y7UCwDrwS8qujQrMA4gzdrcCAMAfqftwHICsdEWAUptcFYCqkv8boJTyAG5k7J8q5k73TGdUUHadNPAC/ek7knl2fABV1At2cN2f8u0GXh68e4bUIZUF+AY4PCLxqYLCedrDv/vIUWDzPM4CjCp+uwRMYDGJRQREBFUr1XMAe9NGFmAF2FZUPO4a9JT+bXqH+7FAb30lno9W4wNOXZXp/Zt5AIVKfEN9u3u5ua/+pCsSERncnd67naXgdPfX4Hk9Ue3DqhRtjQUR7tvfeOWee71I9SwSWmZnHXYeaLzoTOqOiezWARgDuq6s58o1HVma05rWnItrwdGEbkMtm3gLAbQWkp6R9nL0dDexGCAMLd2uYWU53hX8He/SXulmrA6AgCj4a9H/PF5Ndte14CWQrCVz7avdr22EEqcaQOUmVK5gfDPbvhE+cPNuZ6mHJfFN3XbMHuXQ34Kq5KsKYGOLntRRfc655NUEL7E0Guq6N+1cMdkDfCsASEA15MeetWudwOAqwRPBOlyzpvj1/wxgEouuqYXmjIuHEBhIphXOlF6Qass/HoCIoGf093Fg6C74hFd9nJ7F3aYviGaLe8CA01QYw5erF9eJbhkS39K+sE50y3zntLRvk2oEw47j0ZL+AMOfg08ktIFM9CddBdaGS4HBFYMuXIfbBp0FmCFP0v8KrOVZ8WRzuqUmJLGFBEosw115AG8Dr9H/pRre0wJ3NJsF2Rj56OJq8PSrtPMfHfMQdWzNGlwAAAAASUVORK5CYII="; };
var getHouseIcon = function () { return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxMzggNzkuMTU5ODI0LCAyMDE2LzA5LzE0LTAxOjA5OjAxICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+IEmuOgAAAdhJREFUWIXt1k+IjVEYBvDf+FtT7LCws1QTC/8yDNEUypqVEklTUkpkZSNRSmrSZMyanWwkkn8bUlJSkxo7moXNTJOJGWPxnW/ucfvuN/c795Jyn7rd93nfc57zdM73ft+hg/8dXfWJc/0fqswfxA5sqDLpyqP18/GSKhPrcAEDIX4ZjORYhT0hnsN9TBeJpBo4j0sR78Vz9AW+FXei+lp8LhJalLD4WVwO8Ve8CvFOPA1x/TnONhKrauAMrka8F9vwOvBduIXlmAm5uTLBKgZO41rE+zAa4u14E+Ljsp0oXbiqgVO4HvHdeBHx2WDibeCrsbRdBgZwI+J78axg3A/ZcbwrqI2nGjgh6/Uc/XhSMv57MPE+ynXhZIqBYxiK+D48LhmfYxpb/N4JN4Ne0waOYjjiB/CwicVzfAsmRqPccNBd0MBFjET8IB5UWDzHFDbjY5QbCfrzKHoTfsER2Xl+UuvxFExiE/YHvgzdCxkYKsi1ggncbVRM+RZ0Y3FJfQo/mxVLMXBP1mqNsBFjf9LAGqxol2aKgcnwP6HWHT3IbxlNbz9pn+McYzgcfrdTRVox0Ba0ciVbp3br6fmbBvIHcCUOFdQr7WqKgXG1B7EIMyW1Djr49/ALJmFP7ZFhsA0AAAAASUVORK5CYII="; };
var getWebIcon = function () { return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAACXBIWXMAAAsTAAALEwEAmpwYAAA4VWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxMzggNzkuMTU5ODI0LCAyMDE2LzA5LzE0LTAxOjA5OjAxICAgICAgICAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iCiAgICAgICAgICAgIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIKICAgICAgICAgICAgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIgogICAgICAgICAgICB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIKICAgICAgICAgICAgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iCiAgICAgICAgICAgIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIj4KICAgICAgICAgPHhtcDpDcmVhdGVEYXRlPjIwMjAtMTAtMDdUMTM6MjI6MzIrMDM6MDA8L3htcDpDcmVhdGVEYXRlPgogICAgICAgICA8eG1wOk1vZGlmeURhdGU+MjAyMC0xMC0wN1QxMzoyMzowMSswMzowMDwveG1wOk1vZGlmeURhdGU+CiAgICAgICAgIDx4bXA6TWV0YWRhdGFEYXRlPjIwMjAtMTAtMDdUMTM6MjM6MDErMDM6MDA8L3htcDpNZXRhZGF0YURhdGU+CiAgICAgICAgIDx4bXA6Q3JlYXRvclRvb2w+QWRvYmUgUGhvdG9zaG9wIENDIDIwMTcgKFdpbmRvd3MpPC94bXA6Q3JlYXRvclRvb2w+CiAgICAgICAgIDxkYzpmb3JtYXQ+aW1hZ2UvcG5nPC9kYzpmb3JtYXQ+CiAgICAgICAgIDxwaG90b3Nob3A6Q29sb3JNb2RlPjM8L3Bob3Rvc2hvcDpDb2xvck1vZGU+CiAgICAgICAgIDx4bXBNTTpJbnN0YW5jZUlEPnhtcC5paWQ6YTQ1MDQ2ZGQtMzUzNi01MjRlLWJkN2MtNzVkMTAwM2NmYjFmPC94bXBNTTpJbnN0YW5jZUlEPgogICAgICAgICA8eG1wTU06RG9jdW1lbnRJRD54bXAuZGlkOmE0NTA0NmRkLTM1MzYtNTI0ZS1iZDdjLTc1ZDEwMDNjZmIxZjwveG1wTU06RG9jdW1lbnRJRD4KICAgICAgICAgPHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD54bXAuZGlkOmE0NTA0NmRkLTM1MzYtNTI0ZS1iZDdjLTc1ZDEwMDNjZmIxZjwveG1wTU06T3JpZ2luYWxEb2N1bWVudElEPgogICAgICAgICA8eG1wTU06SGlzdG9yeT4KICAgICAgICAgICAgPHJkZjpTZXE+CiAgICAgICAgICAgICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0iUmVzb3VyY2UiPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6YWN0aW9uPnNhdmVkPC9zdEV2dDphY3Rpb24+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDppbnN0YW5jZUlEPnhtcC5paWQ6YTQ1MDQ2ZGQtMzUzNi01MjRlLWJkN2MtNzVkMTAwM2NmYjFmPC9zdEV2dDppbnN0YW5jZUlEPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6d2hlbj4yMDIwLTEwLTA3VDEzOjIzOjAxKzAzOjAwPC9zdEV2dDp3aGVuPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6c29mdHdhcmVBZ2VudD5BZG9iZSBQaG90b3Nob3AgQ0MgMjAxNyAoV2luZG93cyk8L3N0RXZ0OnNvZnR3YXJlQWdlbnQ+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDpjaGFuZ2VkPi88L3N0RXZ0OmNoYW5nZWQ+CiAgICAgICAgICAgICAgIDwvcmRmOmxpPgogICAgICAgICAgICA8L3JkZjpTZXE+CiAgICAgICAgIDwveG1wTU06SGlzdG9yeT4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgICAgPHRpZmY6WFJlc29sdXRpb24+NzIwMDAwLzEwMDAwPC90aWZmOlhSZXNvbHV0aW9uPgogICAgICAgICA8dGlmZjpZUmVzb2x1dGlvbj43MjAwMDAvMTAwMDA8L3RpZmY6WVJlc29sdXRpb24+CiAgICAgICAgIDx0aWZmOlJlc29sdXRpb25Vbml0PjI8L3RpZmY6UmVzb2x1dGlvblVuaXQ+CiAgICAgICAgIDxleGlmOkNvbG9yU3BhY2U+NjU1MzU8L2V4aWY6Q29sb3JTcGFjZT4KICAgICAgICAgPGV4aWY6UGl4ZWxYRGltZW5zaW9uPjk2PC9leGlmOlBpeGVsWERpbWVuc2lvbj4KICAgICAgICAgPGV4aWY6UGl4ZWxZRGltZW5zaW9uPjk2PC9leGlmOlBpeGVsWURpbWVuc2lvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
    "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA" +
    "gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgCjw/eHBhY2tldCBlbmQ9InciPz7NqD8BAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAqUSURBVHja7J19UBTnHcefe3+TO24POA4OOE+Fgx4SVEQ6mCpRQU0DVhKJ7TR2Os40WqttYtRReTFa0Th5mVqd6eSl6TQJjVolo4JWIY00vsuLCIiKvN8d3Asc3uveS/+oVMcxt7t3e3e73H5n+IO93z77PL/PPm+7z/4emtfrBZTCJzrlAgoABYASBYACQIkCQAGgFHoxkQy2L+sMW+bGbYMfme2aODtsFjvcj6JhlzU6O+n1NKTz2jW1VzmMaWNcltAk5CboRLzELeEqQ/X59MAAhFJOt3Xv8HirSgHlrQYAABFPDkQ8OeZ01LLi3GcObW4bOtEs4iU+kAkzu9lMwU7S1IBQyGDpOSIRKN9kM/hAAeUF5RqzE1dnAwCyAQDg9vDJZQmirOsSgXJDxPYBbg9c1We8cgwA4JU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"; };
var getConfig = function () { return ({
    Colors: {
        Primary: "#7745D6",
        Secondary: "#F5E2FF",
        Disabled: "#AFAFAF"
    },
    Links: {
        Base: "keela.co",
        addInCRM: "https://www.keela.co",
        API: "keela.co/api/v1",
        Help: "https://keelahelpcenter.zendesk.com/hc/en-us",
        Settings: "https://www.keela.co",
        Support: "https://keela.zendesk.com/hc/en-us/requests/new",
        SupportBeforeJan: "https://keela.zendesk.com/hc/en-us",
        SupportAfterJan: "https://keelahelpcenter.zendesk.com/hc/en-us"
    },
    Properties: {
        State: "application_state"
    },
    Strings: {
        Cards: {
            Error: {
                Title: "Add-on Issue",
                Reason: {
                    Long: "Something went wrong"
                }
            },
            Forbidden: {
                Title: "No access",
                Reason: {
                    Long: "We couldn't query your account due to invalid or expired token",
                    Short: "Invalid token"
                }
            },
            Help: {
                Title: "Help & Support",
                Action: "Submit",
                Prompt: "Submit a request (please provide detailed description of the issue)",
                Before2020: "For signed up before Jan 22, 2020",
                After2020: "For signed up after Jan 22, 2020"
            },
            Home: {
                Title: "Keela Home",
                Prompt: "Open an email to start browsing your contacts"
            },
            Missing: {
                Action: "Add in Keela",
                Prompt: "No contact matched the open email"
            },
            Region: {
                Title: "Region",
                Prompt: "Please, choose your organization region (it should match the one you chose for the account)"
            },
            Unavailable: {
                Title: "Keela Unavailable",
                Prompt: "We are sorry, but Keela seems to be unavailable.\nTry again later or contact support"
            },
            Display: {
                Header: {
                    Missing: "Unnamed",
                    Alt: "Picture"
                }
            }
        },
        FTE: {
            Action: "Get Started",
            Auth: {
                Action: "Choose Region",
                Button: "Take me there",
                Checkups: {
                    NeverShare: "Never share it with others",
                    StoreSecure: "Store it in a secure location"
                },
                Title: "Authorize Keela",
                Token: "Access to your account is granted via token. You can get one in account settings"
            },
            Finish: {
                Action: "Start Browsing"
            },
            Welcome: "Keela for Gmail allows you to view and edit contacts while browsing your email",
            Tasks: {
                Highlights: "View contact highlights & insights",
                Transactions: "View latest transactions & total donations"
            },
            Title: "Welcome to Keela"
        },
        Settings: {
            Title: "Settings",
            Token: {
                Action: "Get Token",
                Required: "The token is required to continue",
                Example: "e.g. 744707f029a249.efs24Sof9Ag4",
                Label: "Token",
                Prompt: "Token can be obtained from your account settings",
                Warning: "Token gives access to sensitive data, please, treat it as password:"
            }
        },
        Notifications: {
            Save: {
                RegionSuccess: "Region Saved!",
                Success: "Successfully Saved!",
                Unauthorized: "Invalid token/region pair!",
                InvalidToken: "Invalid token!"
            }
        }
    }
}); };
/* global onMessageOpen, getState */
/**
 * @summary builds home card
 * @param {EventObject} e add-on event object
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function buildHome(e) {
    return onMessageOpen(e);
}
/**
 * @typedef {object} HomepageEventObject
 * @property {CommonEventObject} commonEventObject
 *
 * @param {HomepageEventObject} e add-on action event object
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function buildHomepage(e) {
    var settings = getState().settings;
    if (settings.firstTime) {
        return welcomeCard();
    }
    return homepageCard();
}
/**
 * @summary builds settings card
 * @param {EventObject} e add-on event object
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function buildSettings(e) {
    var settings = getSettings();
    return settingsCard(settings);
}
/**
 * @summary builds authorization FTE card
 * @param {EventObject} e add-on event object
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function buildAuthFTE(e) {
    var settings = getSettings();
    var page = getParameters(e).page;
    return authFTEcard(settings, page);
}
/**
 * @summary builds help card
 * @param {EventObject} e add-on event object
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function buildHelp(e) {
    return helpCard();
}
/**
 * @summary builds welcome card
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function buildWelcome() {
    return welcomeCard();
}
/**
 * @summary pre-setup completion check (to avoid reseting to welcome)
 * @param {gmailEventObject} e Gmail add-on-specific event object
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function onSetupCompletion(e) {
    var settings = getSettings();
    if (settings.firstTime) {
        settings.save();
    }
    return onMessageOpen(e);
}
/**
 * @enum
 * @type {{
 *  BUTTON : string,
 *  IMAGE  : string
 * }}
 */
var WidgetTypes = (function (e) {
    e[e.IMAGE = "Image"] = 0;
    e[e.BUTTON = "TextButton"] = 1;
    return e;
})({});
/**
 * @fileoverview contains build steps for first-time user experience
 */
/**
 * @summary Build FTE card;
 * @param {EventObject} e add-on event object
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function buildFTE(e) {
    var params = getParameters(e);
    var page = +(params.page || 0);
    var pageMap = new Map([
        [0, buildWelcome],
        [1, buildAuthFTE]
    ]);
    return Cardin.actionResponse({
        event: e,
        reload: {
            type: Cardin.Response.ACTION,
            card: pageMap.get(page) || buildWelcome
        }
    });
}
/**
 * @typedef {object} InputsWrapper
 * @property {stringInputs} [stringInputs]
 * @property {dateInput} [dateInput]
 * @property {dateTimeInput} [dateTimeInput]
 * @property {timeInput} [timeInput]
 *
 * @typedef {object} stringInputs
 * @property {string[]} value
 *
 * @typedef {object} dateInput
 * @property {string} msSinceEpoch
 *
 * @typedef {object} timeInput
 * @property {number} hours
 * @property {number} minutes
 *
 * @typedef {object} dateTimeInput
 * @property {boolean} hasDate
 * @property {boolean} hasTime
 * @property {string} msSinceEpoch
 */
/**
 * @typedef {object} commonEventObject
 * @property {("GMAIL" | "CALENDAR" | "DRIVE")} hostApp
 * @property {("WEB"|"IOS"|"ANDROID")} platform
 * @property {Object.<string, InputsWrapper>} formInputs
 * @property {object} parameters
 * @property {string} [timeZone]
 * @property {string} [timeZone.id]
 * @property {string} [timeZone.offset]
 * @property {string} [userLocale]
 */
/**
 * @summary Calendar event object
 * @typedef {object} calendarEventObject
 */
/**
 * @summary Drive event object
 * @typedef {object} driveEventObject
 */
/**
 * @summary Gmail event object
 * @typedef {object} gmailEventObject
 * @property {string} accessToken
 * @property {string[]} [bccRecipients] iff addOns.gmail.composeTrigger.draftAccess = "METADATA"
 * @property {string[]} [ccRecipients] iff addOns.gmail.composeTrigger.draftAccess = "METADATA"
 * @property {string} messageId
 * @property {string} threadId
 * @property {string[]} [toRecipients] iff addOns.gmail.composeTrigger.draftAccess = "METADATA"
 */
/**
 * @typedef {object} EventObject
 * @property {commonEventObject} commonEventObject
 * @property {calendarEventObject} calendar
 * @property {driveEventObject} drive
 * @property {gmailEventObject} gmail
 */
/**
 * @typedef {object} ParsedMessage
 * @property {string} body
 * @property {string[]} cc
 * @property {string} domain
 * @property {string} email
 * @property {string} first
 * @property {string} last
 * @property {string} name
 * @property {string} subject
 * @property {string[]} to
 */
/**
 * @typedef {Object} SectionConfig
 * @property {String} [header] section header line
 * @property {Boolean} isCollapsible render collapsed or expanded
 * @property {Number} [numUncollapsible=0] number of widgets uncollapsed
 * @property {WidgetConfig[]} widgets collection of widget configurations
 */
/**
 * @typedef {Object} CardHeaderConfig
 * @property {String} title header title line
 * @property {String} [subtitle] header subtitle line
 * @property {String} [image] image URL to set on the left of the header
 * @property {Boolean} [crop=false] square or circle image style
 * @property {String} [alt] alternative text on image load failure
 * @throws {Error} if no title provided
 */
/**
 * @typedef {Object} CardConfig
 * @property {CardHeaderConfig} header header of the card
 * @property {String} [name] name uniquely identifying card
 * @property {SectionConfig[]} sections section configurations
 * @property {ActionConfig[]} [actions] actions to add to menu
 */
/**
 * @typedef {Object} ProcessedResponse
 * @property {Number} code
 * @property {Object} headers
 * @property {String} content
 */
/**
 * @typedef {UserSettings} KeelaSettings
 */
/**
 * @summary runs on each message open
 * @param {gmailEventObject} e Gmail add-on event object
 */
function onMessageOpen(e) {
    var instance = getState();
    var settings = instance.settings;
    if (settings.firstTime) {
        return welcomeCard();
    }
    settings.reload();
    var message = Cardin.getMessage(e);
    if (!message) {
        return homepageCard();
    }
    /** @type {ParsedMessage} */
    var parsedMessage = Cardin.trimMessage(message);
    return homeCard(instance, parsedMessage);
}
/* global Cardin, Objects */
/**
 * @typedef {object} ConnectorConfig
 * @property {string} base
 * @property {string} endpoints
 */
var Connector = /** @class */ (function () {
    /**
     * @param {ConnectorConfig} config
     * @param {UserSettings} settings
     */
    function Connector(config, settings) {
        var _this = this;
        Object.entries(config).forEach(function (_a) {
            var _b = __read(_a, 2), k = _b[0], v = _b[1];
            return _this[k] = v;
        });
        this.settings = settings;
    }
    Object.defineProperty(Connector.prototype, "token", {
        get: function () {
            var token = this.settings.token;
            return token;
        },
        enumerable: false,
        configurable: true
    });
    /**
     * @summary builds error Card
     * @returns {CardConfig}
     */
    Connector.prototype.buildError = function () {
        return {
            header: {
                image: Cardin.Icon.WARNING,
                title: "Add-on failure"
            },
            sections: [{
                    widgets: [getSupportWidgetConfg({
                            text: "Something went wrong. Please contact support"
                        })]
                }]
        };
    };
    /**
     * @summary constructs full URL
     * @param {string[]} subdomains
     * @param {string} domain
     * @param {string[]} [paths]
     * @param {object} [query]
     * @returns {string}
     */
    Connector.prototype.buildFullURL = function (subdomains, domain, paths, query) {
        subdomains.push(domain);
        var base = subdomains.join(".");
        var path = (paths || []).length ? "/".concat(paths.join("/")) : "";
        var builtQuery = query ? "?".concat(JSONtoQuery(query)) : "";
        var protocol = (/^https:\/\//).test(base) ? "" : "https://";
        return "".concat(protocol).concat(base).concat(path).concat(builtQuery);
    };
    /**
     * @returns {boolean}
     */
    Connector.prototype.isBearer = function () {
        var authType = this.settings.authType;
        return authType === "BEARER";
    };
    /**
     * @returns {boolean}
     */
    Connector.prototype.isBasic = function () {
        var authType = this.settings.authType;
        return authType === "BASIC";
    };
    return Connector;
}());
/**
 * @typedef {{ title: string, subtitle ?: string, image ?: string, crop ?: boolean, alt ?: string }} HeaderConfig
 */
/**
 * @typedef {{ type : string }} BaseWidgetConfig
 * @typedef {BaseWidgetConfig & {
 *  title   ?: string,
 *  text    ?: string,
 *  state   ?: string,
 *  src     ?: string,
 *  content ?: string,
 *  action  ?: "change"|"click"|"link"
 * }} PossibleWidgetConfig
 */
/**
 * @summary checks widget validity
 * @param {PossibleWidgetConfig}
 * @returns {boolean}
 */
var widgetValidityChecker = function (_a) {
    var type = _a.type, src = _a.src, content = _a.content;
    if (type === WidgetTypes.IMAGE) {
        return !!(src || content);
    }
    return true;
};
/**
 * @summary validates config type
 * @param {PossibleWidgetConfig} config
 * @returns {PossibleWidgetConfig}
 */
var configTypeValidator = function (config) {
    var type = config.type;
    if (!type) {
        return config;
    }
    var maybeLib = type.split(".");
    if (maybeLib.length === 1) {
        return config;
    }
    var _a = __read(maybeLib, 3), enumerator = _a[1], val = _a[2];
    config.type = Cardin[enumerator][val];
    return config;
};
/**
 * @summary main config validator
 * @param {PossibleWidgetConfig} config
 * @returns {PossibleWidgetConfig}
 */
var configValidator = function (config, cf) {
    if (cf === void 0) { cf = getConfig(); }
    var valid = configTypeValidator(config);
    var action = valid.action, color = valid.color, colour = valid.colour, content = valid.content, text = valid.text, title = valid.title, type = valid.type;
    if (!type && !content) {
        valid.state = Cardin.State.HIDDEN;
    }
    if (type === WidgetTypes.BUTTON) {
        valid.type = Cardin.Type.TEXT_BUTTON;
        valid.text = text || title || content;
        valid.color = color || colour || cf.Colors.Primary;
    }
    if (type === WidgetTypes.IMAGE) {
        valid.type = Cardin.Type.IMAGE;
    }
    if (action === "link") {
        valid.link = { url: content, tab: true };
    }
    return valid;
};
/**
 * @summary card header validator
 * @param {HeaderConfig} header
 * @returns {HeaderConfig}
 */
var headerValidator = function (header, cf) {
    if (cf === void 0) { cf = getConfig(); }
    return assignToEmpty(header, {
        title: cf.Strings.Cards.Display.Header.Missing,
        alt: header.image ? header.alt || cf.Strings.Cards.Display.Header.Alt : "",
        crop: true
    });
};
var Keela = /** @class */ (function (_super) {
    __extends(Keela, _super);
    /**
     * @param {ConnectorConfig} config
     * @param {UserSettings} settings
     */
    function Keela(config, settings) {
        return _super.call(this, config, settings) || this;
    }
    Object.defineProperty(Keela.prototype, "apiURI", {
        /**
         * @summary returns Keela API URI (region-aware)
         * @returns {string}
         */
        get: function () {
            var _a = this, base = _a.base, region = _a.settings.region;
            return "https://".concat(isDev() ? "dev" : region, ".").concat(base);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(Keela.prototype, "queryContactConfig", {
        /**
         * @summary returns API request configuration
         * @returns {object}
         */
        get: function () {
            var apiURI = this.apiURI;
            var config = FetchApp.getConfig({
                domain: apiURI,
                paths: ["contacts"],
                mute: true
            });
            return config;
        },
        enumerable: false,
        configurable: true
    });
    /**
     * @summary gets regional-based Keela URI
     * @param {object} [cf] add-on configuration
     * @returns {string}
     */
    Keela.prototype.getKeelaURI = function (cf) {
        if (cf === void 0) { cf = getConfig(); }
        var region = this.settings.region;
        return region ? "https://".concat(isDev() ? "dev" : region, ".").concat(cf.Links.Base) : cf.Links.Settings;
    };
    /**
     * @summary builds add-on view cards
     * @param {string} content view JSON content
     * @returns {CardConfig[]}
     */
    Keela.prototype.buildDisplay = function (content) {
        var cardConfigs = JSON.parse(content);
        var cf = getConfig();
        return cardConfigs.map(function (_a) {
            var header = _a.header, sections = _a.sections;
            var validHeader = headerValidator(header, cf);
            sections.forEach(function (section) {
                var _a = section.widgets, widgets = _a === void 0 ? [] : _a;
                var correctedWidgets = widgets
                    .filter(function (c) { return widgetValidityChecker(c); })
                    .map(function (c) { return configValidator(c, cf); });
                section.widgets = correctedWidgets;
            });
            return { header: validHeader, sections: sections };
        });
    };
    /**
     * @summary builds an "unavailable" Card
     * @returns {CardConfig}
     */
    Keela.prototype.buildUnavailable = function () {
        var cf = getConfig();
        return {
            header: {
                image: Cardin.Icon.WARNING,
                title: cf.Strings.Cards.Unavailable.Title
            },
            sections: [{
                    widgets: [getSupportWidgetConfg({
                            text: cf.Strings.Cards.Unavailable.Prompt
                        })]
                }]
        };
    };
    /**
     * @summary builds a "no access" Card
     * @returns {CardConfig}
     */
    Keela.prototype.buildNoAccess = function () {
        var token = this.token;
        var cf = getConfig();
        return {
            header: {
                image: getLockIcon(),
                title: cf.Strings.Cards.Forbidden.Title
            },
            sections: [{
                    header: cf.Strings.Cards.Forbidden.Reason.Short,
                    widgets: [{
                            content: cf.Strings.Cards.Forbidden.Reason.Long
                        },
                        {
                            content: cf.Strings.Settings.Token.Prompt,
                            buttonConfig: {
                                type: Cardin.Type.TEXT_BUTTON,
                                icon: Cardin.Icon.TAB,
                                text: Cardin.Formatter.colorize(cf.Colors.Primary, cf.Strings.Settings.Token.Action),
                                link: {
                                    url: this.getKeelaURI(cf),
                                    tab: true
                                }
                            }
                        },
                        {
                            change: {
                                callback: saveWithPing.name,
                                params: {
                                    builderName: onMessageOpen.name,
                                    message: cf.Strings.Notifications.Save.InvalidToken
                                },
                                spinner: true
                            },
                            name: "token",
                            content: token,
                            title: cf.Strings.Settings.Token.Label,
                            hint: cf.Strings.Settings.Token.Example
                        }]
                }]
        };
    };
    /**
     * @summary builds contact not found card
     * @param {ParsedMessage} message Gmail message
     * @returns {CardConfig}
     */
    Keela.prototype.buildNotFound = function (message) {
        var email = message.email, name = message.name, domain = message.domain;
        var cf = getConfig();
        return {
            header: {
                image: getPersonIcon(),
                title: name,
                subtitle: email
            },
            sections: [{
                    widgets: [{
                            content: cf.Strings.Cards.Missing.Prompt
                        },
                        { icon: "PERSON", content: name },
                        { icon: "EMAIL", content: email },
                        {
                            icon: Cardin.Icon.COMPANY,
                            content: domain
                        },
                        {
                            colour: cf.Colors.Primary,
                            type: Cardin.Type.TEXT_BUTTON,
                            text: cf.Strings.Cards.Missing.Action,
                            link: {
                                url: "".concat(this.getKeelaURI(cf), "/contacts"),
                                tab: true,
                                reload: true
                            }
                        }]
                }]
        };
    };
    /**
     * @summary runs instance against API
     * @param {ParsedMessage} message Gmail message
     * @returns {CardConfig|CardConfig[]}
     */
    Keela.prototype.run = function (message) {
        var _this = this;
        var email = message.email;
        var _a = this, queryContactConfig = _a.queryContactConfig, token = _a.token;
        if (!token)
            return this.buildNoAccess();
        queryContactConfig.addParam("email", email);
        queryContactConfig.addHeader("apiToken", token);
        var params = queryContactConfig.json({
            "mute": "muteHttpExceptions"
        }, {
            include: ["url", "headers", "mute"]
        });
        var _b = __read(batchFetch([params]), 1), mainResponse = _b[0];
        if (isDev()) {
            console.log(mainResponse);
            console.log(params);
        }
        var reponseHandlerMap = new Map()
            .set(200, function (content) { return _this.buildDisplay(content); })
            .set(400, function () { return _this.buildError(); })
            .set(401, function () { return _this.buildNoAccess(); })
            .set(404, function () { return _this.buildNotFound(message); })
            .set(500, function () { return _this.buildUnavailable(); });
        var code = mainResponse.code, content = mainResponse.content;
        var defaultHandler = reponseHandlerMap.get(500);
        return (reponseHandlerMap.get(code) || defaultHandler)(content);
    };
    /**
     * @summary pings Keela endpoint for access
     * @param {UserSettings} settings user settings
     * @returns {boolean}
     */
    Keela.ping = function (settings) {
        var region = settings.region, token = settings.token;
        var API = getConfig().Links.API;
        var _a = __read(batchFetch([
            {
                url: "https://".concat(isDev() ? "dev" : region, ".").concat(API, "/contacts?email="),
                headers: {
                    "apiToken": token
                }
            }
        ], true), 1), response = _a[0];
        if (isDev()) {
            console.log(response);
        }
        var code = response.code;
        return code;
    };
    /**
     * @summary checks if a token / region combination is valid
     * @param {UserSettings} settings user settings
     * @returns {boolean}
     */
    Keela.isAuthorized = function (settings) {
        var token = settings.token;
        if (isFalsyOrEmptyStr(token)) {
            return false;
        }
        return Keela.ping(settings) !== 401;
    };
    return Keela;
}(Connector));
/**
 * @fileoverview Array utilities
 * @author Oleg Valter
 * @module
 */
(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
        define([], factory);
    }
    else if (typeof module === 'object' && module.exports) {
        module.exports = factory();
    }
    else {
        root.Arrays = factory();
    }
}(typeof self !== 'undefined' ? self : this, function () {
    /**
     * Combines filter() and map() in O(n)
     * @param {any[]} [array]
     * @returns {function(function):function(function):any[]}
     */
    var filterMap = function (array) {
        if (array === void 0) { array = []; }
        return function (filter) {
            if (filter === void 0) { filter = function (e) { return true; }; }
            return function (mapper) {
                var e_1, _a;
                if (mapper === void 0) { mapper = function (e) { return e; }; }
                var mappedArr = [];
                var initialIndex = 0, filteredIndex = 0;
                try {
                    for (var array_1 = __values(array), array_1_1 = array_1.next(); !array_1_1.done; array_1_1 = array_1.next()) {
                        var elem = array_1_1.value;
                        filter(elem, initialIndex++) &&
                            mappedArr.push(mapper(elem, filteredIndex++));
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (array_1_1 && !array_1_1.done && (_a = array_1.return)) _a.call(array_1);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
                return mappedArr;
            };
        };
    };
    /**
     * Combines filter() and map() in reverse in O(n)
     * @param {any[]} [array]
     * @returns {function(function):function(function):any[]}
     */
    var filterMapped = function (array) {
        if (array === void 0) { array = []; }
        return function (mapper) {
            if (mapper === void 0) { mapper = function (e) { return e; }; }
            return function (filter) {
                var e_2, _a;
                if (filter === void 0) { filter = function (e) { return true; }; }
                var filteredArr = [];
                var initialIndex = 0, filteredIndex = 0;
                try {
                    for (var array_2 = __values(array), array_2_1 = array_2.next(); !array_2_1.done; array_2_1 = array_2.next()) {
                        var elem = array_2_1.value;
                        var mappedElem = mapper(elem, initialIndex++);
                        filter(mappedElem, filteredIndex++) &&
                            filteredArr.push(mappedElem);
                    }
                }
                catch (e_2_1) { e_2 = { error: e_2_1 }; }
                finally {
                    try {
                        if (array_2_1 && !array_2_1.done && (_a = array_2.return)) _a.call(array_2);
                    }
                    finally { if (e_2) throw e_2.error; }
                }
                return filteredArr;
            };
        };
    };
    /**
     * Executes a callback for each element
     * (same as forEach, but in FP style + faster)
     * @param {any[]} [array]
     * @returns {function(function):void}
     */
    var forAll = function (array) {
        if (array === void 0) { array = []; }
        return function (callback) {
            var e_3, _a;
            var index = 0;
            try {
                for (var array_3 = __values(array), array_3_1 = array_3.next(); !array_3_1.done; array_3_1 = array_3.next()) {
                    var elem = array_3_1.value;
                    callback(elem, index++);
                }
            }
            catch (e_3_1) { e_3 = { error: e_3_1 }; }
            finally {
                try {
                    if (array_3_1 && !array_3_1.done && (_a = array_3.return)) _a.call(array_3);
                }
                finally { if (e_3) throw e_3.error; }
            }
            return;
        };
    };
    /**
     * Maps array to values of
     * property by key
     * @param {any[]} [array]
     * @returns {function(string):any[]}
     */
    var keyMap = function (array) {
        if (array === void 0) { array = []; }
        return function (key) {
            return !key ? array : array.map(function (elem) { return elem[key]; });
        };
    };
    /**
     * @summary merges arrays
     * @param {any[]} source
     * @param  {...any[]} [targets]
     * @returns {any[]}
     */
    var mergeOnto = function (source) {
        var e_4, _a;
        var targets = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            targets[_i - 1] = arguments[_i];
        }
        var output = [];
        for (var index = 0; index < source.length; index++) {
            var item = source[index];
            if (typeof item === "undefined") {
                var finalValue = item;
                try {
                    for (var targets_1 = (e_4 = void 0, __values(targets)), targets_1_1 = targets_1.next(); !targets_1_1.done; targets_1_1 = targets_1.next()) {
                        var target = targets_1_1.value;
                        finalValue = target[index];
                    }
                }
                catch (e_4_1) { e_4 = { error: e_4_1 }; }
                finally {
                    try {
                        if (targets_1_1 && !targets_1_1.done && (_a = targets_1.return)) _a.call(targets_1);
                    }
                    finally { if (e_4) throw e_4.error; }
                }
                output.push(finalValue);
                continue;
            }
            output.push(item);
        }
        return output;
    };
    /**
     *
     * @param {any[]} source
     * @param {...any[]} targets
     * @returns {any[]}
     */
    var spliceInto = function (source) {
        var e_5, _a;
        var targets = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            targets[_i - 1] = arguments[_i];
        }
        var output = source.map(function (item) { return item; }); //shallow copy;
        try {
            for (var targets_2 = __values(targets), targets_2_1 = targets_2.next(); !targets_2_1.done; targets_2_1 = targets_2.next()) {
                var target = targets_2_1.value;
                target.forEach(function (item, index) {
                    if (typeof item !== "undefined") {
                        output.splice(index, 0, item);
                    }
                });
            }
        }
        catch (e_5_1) { e_5 = { error: e_5_1 }; }
        finally {
            try {
                if (targets_2_1 && !targets_2_1.done && (_a = targets_2.return)) _a.call(targets_2);
            }
            finally { if (e_5) throw e_5.error; }
        }
        return output;
    };
    return {
        filterMap: filterMap,
        filterMapped: filterMapped,
        forAll: forAll,
        keyMap: keyMap,
        mergeOnto: mergeOnto,
        spliceInto: spliceInto
    };
}));
(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
        define([], factory);
    }
    else if (typeof module === 'object' && module.exports) {
        module.exports = factory();
    }
    else {
        root.utilJSON = factory();
    }
}(typeof self !== 'undefined' ? self : this, function () {
    /**
     * @summary converts object to query
     * @param {object} json parameters
     * @returns {string} query string
     */
    function JSONtoQuery(json) {
        /**
         * @summary recursive parser
         * @param {object} obj
         * @param {string} seq
         * @returns {string[]}
         */
        var deep = function (obj, seq) {
            var output = [];
            for (var key in obj) {
                if (typeof obj[key] === "object") {
                    output.push(deep(obj[key], "".concat(seq ? seq + '[' : '').concat(key).concat(seq ? ']' : '')));
                }
                else if (obj[key] !== undefined) {
                    output.push("".concat(seq ? seq + '[' : '').concat(key).concat(seq ? ']' : '', "=").concat(obj[key]));
                }
            }
            return output.reduce(function (r, c) { return r.concat(c); }, []);
        };
        return deep(json).join('&');
    }
    return {
        JSONtoQuery: JSONtoQuery
    };
}));
(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
        define([], factory);
    }
    else if (typeof module === 'object' && module.exports) {
        module.exports = factory();
    }
    else {
        root.Objects = factory();
    }
}(typeof self !== 'undefined' ? self : this, function () {
    /**
     * @summary checks if an object is a valid object
     * @param {object} obj
     * @returns {boolean}
     */
    var isObject = function (obj) { return typeof obj === 'object' && obj !== null && !Array.isArray(obj); };
    /**
     * @summary pushes value in or inits array with value
     * @param {object} obj
     * @param {string} key
     * @param {*} value
     * @returns {object}
     */
    var pushOrInitProp = function (obj, key, value) {
        if (key in obj) {
            var temp = obj[key];
            if (Array.isArray(temp)) {
                temp.push(value);
                return obj;
            }
            obj[key] = [temp, value];
            return obj;
        }
        obj[key] = [value];
        return obj;
    };
    /**
     * @typedef {object} SetOptions
     * @property {string} [coerce]
     *
     *
     * @summary copies property if it exists
     * @param {object} source
     * @param {string} key
     * @param {object} [target]
     * @param {SetOptions} [options]
     * @returns {object}
     */
    var setIf = function (source, key, target, options) {
        if (target === void 0) { target = {}; }
        if (options === void 0) { options = {}; }
        if (typeof key !== "string") {
            return target;
        }
        /** @type {Map<string, function>} */
        var coercionMap = new Map()
            .set("string", function (val) {
            if (typeof val === "string") {
                return val;
            }
            if (typeof val === "number") {
                return Number.prototype.toString.call(val);
            }
            return val;
        });
        var coerce = options.coerce;
        if (key in source) {
            var value = source[key];
            target[key] = coerce ? (coercionMap.get(coerce))(value) : value;
        }
        return target;
    };
    /**
     * @summary defines a smart (memoizable) getter
     * {@link https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/get}
     * @param {object} context
     * @param {string} propName
     * @param {function} callback
     * @returns {object}
     */
    var smartGetter = function (context, propName, callback) {
        return Object.defineProperty(context, propName, {
            configurable: true,
            get: function () {
                var temp = callback(context);
                Object.defineProperty(context, propName, {
                    value: temp
                });
                return temp;
            }
        });
    };
    /**
     * @summary returns one of the object props equal
     * @param {object} [target] first object to compare
     * @param {string} propName property name
     */
    var switchIfDiffProp = function (target, propName) {
        /**
         * @param {object} [source] second object to compare
         * @returns {object}
         */
        return function (source) {
            if (!target) {
                return source || {};
            }
            if (!source) {
                return target || {};
            }
            return target[propName] === source[propName] ?
                target :
                source;
        };
    };
    /**
     * @summary makes a union of object
     * @param {object} target
     * @param  {...object} sources
     * @returns {object}
     */
    var union = function (target) {
        var e_6, _a;
        var sources = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            sources[_i - 1] = arguments[_i];
        }
        var union = Object.assign({}, target);
        var assignedKeys = {};
        try {
            for (var sources_1 = __values(sources), sources_1_1 = sources_1.next(); !sources_1_1.done; sources_1_1 = sources_1.next()) {
                var source = sources_1_1.value;
                for (var key in source) {
                    if (!assignedKeys[key] && !(key in union)) {
                        assignedKeys[key] |= 1;
                        union[key] = source[key];
                    }
                }
            }
        }
        catch (e_6_1) { e_6 = { error: e_6_1 }; }
        finally {
            try {
                if (sources_1_1 && !sources_1_1.done && (_a = sources_1.return)) _a.call(sources_1);
            }
            finally { if (e_6) throw e_6.error; }
        }
        return union;
    };
    /**
     * @summary checks which key is set on object
     * @param {object} obj
     * @param  {...string} keys
     * @returns {string[]}
     */
    var whichKeysAreSet = function (obj) {
        var keys = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            keys[_i - 1] = arguments[_i];
        }
        return keys.filter(function (key) { return obj.hasOwnProperty(key); });
    };
    return {
        isObject: isObject,
        pushOrInitProp: pushOrInitProp,
        setIf: setIf,
        smartGetter: smartGetter,
        switchIfDiffProp: switchIfDiffProp,
        union: union,
        whichKeysAreSet: whichKeysAreSet
    };
}));
/**
 * @summary HTTPResponse -> ProcessedResponse map
 * @param {GoogleAppsScript.URL_Fetch.HTTPResponse} response
 * @returns {ProcessedResponse}
 */
var responseToJSON = function (response) { return ({
    code: response.getResponseCode(),
    headers: response.getHeaders(),
    content: response.getContentText()
}); };
/**
 * @summary adds mute option to configuration
 * @param {GoogleAppsScript.URL_Fetch.URLFetchRequest} config
 * @returns {GoogleAppsScript.URL_Fetch.URLFetchRequest}
 */
var addMute = function (config) { return (__assign(__assign({}, config), { muteHttpExceptions: true })); };
/**
 * @summary issues requests in batch
 * @param {GoogleAppsScript.URL_Fetch.URLFetchRequest[]} configs
 * @returns {ProcessedResponse[]}
 */
var batchFetch = function (configs, mute) {
    if (mute === void 0) { mute = false; }
    try {
        var responses = UrlFetchApp.fetchAll(mute ? configs.map(addMute) : configs);
        return responses.map(responseToJSON);
    }
    catch (_a) {
        var message = _a.message;
        return [{
                code: 0,
                headers: {},
                content: message
            }];
    }
};
/* global Cardin, getState, getParameters, getInputValues */
var UserSettings = /** @class */ (function () {
    /**
     * @param {object} config user settings configuration
     * @param {("BASIC"|"BEARER")} [config.authType="BASIC"] authorization type
     * @param {boolean} [config.firstTime=true] first-time user state
     * @param {number} [config.lastUpdated] timestamp of the last update
     * @param {string} [config.token] access token
     * @param {string} [config.region] user region
     */
    function UserSettings(_a) {
        var _b = _a.authType, authType = _b === void 0 ? "BEARER" : _b, _c = _a.firstTime, firstTime = _c === void 0 ? true : _c, _d = _a.lastUpdated, lastUpdated = _d === void 0 ? Date.now() : _d, _e = _a.token, token = _e === void 0 ? "" : _e, _f = _a.region, region = _f === void 0 ? "usa" : _f;
        this.authType = authType;
        this.firstTime = firstTime;
        this.lastUpdated = lastUpdated;
        this.region = region;
        this.token = token;
    }
    Object.defineProperty(UserSettings.prototype, "canAuth", {
        /**
         * @summary checks if there is any point to authorize
         * @returns {boolean}
         */
        get: function () {
            var _a = this, firstTime = _a.firstTime, token = _a.token;
            return !firstTime && token !== "";
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(UserSettings.prototype, "localeTimestamp", {
        /**
         * @summary locale-formats a timestamp
         * @returns {string}
         */
        get: function () {
            var lastUpdated = this.lastUpdated;
            return new Date(lastUpdated).toLocaleString();
        },
        enumerable: false,
        configurable: true
    });
    /**
     * @summary internal toJSON override
     * @param {string} key current object key
     * @returns {object}
     */
    UserSettings.prototype.toJSON = function (_key) {
        var e_7, _a;
        var ignore = [
            "constructor",
            "toString",
            "canAuth",
            "localeTimestamp"
        ];
        var temp = {};
        /**
         *
         * @param {object} obj
         * @returns {string[]}
         */
        var getAllNames = function (obj) {
            var protoNames = Object.getOwnPropertyNames(Object.getPrototypeOf(obj || {}));
            var ownNames = Object.getOwnPropertyNames(obj);
            return __spreadArray(__spreadArray([], __read(protoNames), false), __read(ownNames), false);
        };
        try {
            for (var _b = __values(getAllNames(this)), _c = _b.next(); !_c.done; _c = _b.next()) {
                var key = _c.value;
                if (!ignore.includes(key)) {
                    temp[key] = this[key];
                }
            }
        }
        catch (e_7_1) { e_7 = { error: e_7_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_7) throw e_7.error; }
        }
        return temp;
    };
    /**
     * @summary reloads settings for use with updated data
     * @returns {UserSettings}
     */
    UserSettings.prototype.reload = function () {
        var _this = this;
        var store = PropertiesService.getUserProperties();
        var saved = store.getProperty("settings");
        var parsed = JSON.parse(saved);
        Object.entries(parsed).forEach(function (_a) {
            var _b = __read(_a, 2), k = _b[0], v = _b[1];
            return _this[k] = v;
        });
        return this;
    };
    /**
     * @summary resets all user settings
     * @returns {UserSettings}
     */
    UserSettings.prototype.reset = function () {
        var store = PropertiesService.getUserProperties();
        store.deleteProperty("settings");
        this.authType = "BEARER";
        this.firstTime = true;
        this.token = "";
        this.lastUpdated = Date.now();
        return this;
    };
    /**
     * @summary saves all user settings
     * @returns {UserSettings}
     */
    UserSettings.prototype.save = function () {
        this.firstTime = false;
        var store = PropertiesService.getUserProperties();
        var prepared = JSON.stringify(this);
        store.setProperty("settings", prepared);
        return this;
    };
    return UserSettings;
}());
/**
 * @summary updates settings
 * @param {EventObject} e add-on event object
 * @returns {UserSettings}
 */
var updateSettings = function (e) {
    var newValues = getInputValues(e);
    var settings = getState().settings;
    Object.entries(newValues).forEach(function (_a) {
        var _b = __read(_a, 2), k = _b[0], _c = __read(_b[1], 1), v = _c[0];
        return settings[k] = v;
    });
    settings.save();
    settings.reload();
    return settings;
};
/**
 * @summary saves settings in background
 * @param {EventObject} e add-on event object
 * @returns {?GoogleAppsScript.Card_Service.ActionResponse}
 */
function backgroundSave(e) {
    updateSettings(e);
    var notify = getParameters(e).notify;
    if (notify) {
        return Cardin.actionResponse({ event: e, notify: notify });
    }
}
/**
 * @summary saves settings with a UI action
 * @param {GoogleAppsScript.Events.AppsScriptEvent} e Apps Script event object
 * @returns {GoogleAppsScript.Card_Service.ActionResponse}
 */
function foregroundSave(e) {
    var builderName = getParameters(e).builderName;
    updateSettings(e);
    var cf = getConfig();
    return Cardin.actionResponse({
        event: e,
        notify: cf.Strings.Notifications.Save.Success,
        navigate: ['root', { update: this[builderName](e) }]
    });
}
/**
 * @summary updates settings with
 * @param {EventObject} e add-on event object
 * @returns {GoogleAppsScript.Card_Service.ActionResponse | null}
 */
var saveWithPing = function (e) {
    var _a = defaultProps(getInputValues(e), ["region", "token"], [""]), _b = __read(_a.region, 1), region = _b[0], _c = __read(_a.token, 1), token = _c[0];
    var _d = getParameters(e), builderName = _d.builderName, message = _d.message;
    var isValid = Keela.isAuthorized({ region: region, token: token });
    var cf = getConfig();
    if (!isValid) {
        return Cardin.actionResponse({
            event: e,
            notify: message || cf.Strings.Notifications.Save.Unauthorized
        });
    }
    return builderName ? foregroundSave(e) : backgroundSave(e);
};
/**
 * @summary resets all settings
 * @param {EventObject} e add-on event object
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function reset(e) {
    var settings = getState().settings;
    settings.reset();
    return buildSettings(e);
}
/**
 * @summary loads settings
 * @returns {UserSettings}
 */
function getSettings() {
    var store = PropertiesService.getUserProperties();
    var stored = store.getProperty("settings");
    return new UserSettings(stored ? JSON.parse(stored) : { firstTime: true });
}
/* global getState, getSettings, Keela */
/**
 * @summary "sigleton"-ish instance getter
 * @returns {Keela}
 */
function getState() {
    var cf = getConfig();
    var stateKey = cf.Properties.State;
    /** @type {Keela} */
    var state = this[stateKey];
    if (state) {
        return state;
    }
    var settings = getSettings();
    var created = new Keela({
        base: cf.Links.API,
        endpoints: ["contacts"]
    }, settings);
    this[stateKey] = created;
    return created;
}
/**
 * @summary Builds settings card;
 * @param {UserSettings} [settings]
 * @param {number} [page]
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function authFTEcard(settings, page) {
    if (settings === void 0) { settings = getSettings(); }
    var _a = settings.region, region = _a === void 0 ? "usa" : _a, _b = settings.token, token = _b === void 0 ? "" : _b;
    var cf = getConfig();
    var hasAccess = Keela.isAuthorized(settings);
    var startBrowsingDefaultConfig = {
        icon: Cardin.Icon.FORWARD,
        content: Cardin.Formatter.format({
            text: cf.Strings.FTE.Finish.Action,
            color: hasAccess ? cf.Colors.Primary : cf.Colors.Disabled,
            bold: hasAccess
        }),
        spaceBefore: true
    };
    if (hasAccess) { //disabled unless token is valid
        startBrowsingDefaultConfig.click = {
            callback: onSetupCompletion.name
        };
    }
    var config = {
        header: {
            image: getKeelaIcon(),
            title: cf.Strings.FTE.Auth.Title
        },
        sections: [
            makeRegionSection(cf, {
                region: region,
                page: page,
                builderName: buildAuthFTE.name,
            }),
            {
                widgets: __spreadArray(__spreadArray([
                    {
                        content: cf.Strings.FTE.Auth.Token,
                        spaceBefore: true
                    },
                    {
                        content: Cardin.Formatter.format({
                            text: cf.Strings.FTE.Auth.Button,
                            color: cf.Colors.Primary,
                            bold: true
                        }),
                        link: {
                            url: region ? "".concat(region, ".").concat(cf.Links.Base) : cf.Links.Base,
                            tab: true
                        }
                    },
                    {
                        content: cf.Strings.Settings.Token.Warning,
                        spaceBefore: true
                    }
                ], __read(getTaskListConfig(cf.Strings.FTE.Auth.Checkups.NeverShare, cf.Strings.FTE.Auth.Checkups.StoreSecure)), false), [
                    {
                        name: "token",
                        content: token,
                        title: cf.Strings.Settings.Token.Label,
                        hint: cf.Strings.Settings.Token.Required,
                        spaceAfter: true,
                        change: {
                            callback: saveWithPing.name,
                            params: {
                                page: page,
                                builderName: buildAuthFTE.name
                            },
                            spinner: true
                        },
                        hintColor: cf.Colors.Primary
                    },
                    startBrowsingDefaultConfig
                ], false)
            }
        ]
    };
    return Cardin.card(config);
}
/**
 * @summary builds help Card
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function helpCard() {
    var cf = getConfig();
    var config = {
        header: {
            title: cf.Strings.Cards.Help.Title
        },
        sections: [{
                header: "Contact Us",
                widgets: [getSupportWidgetConfg({
                        text: cf.Strings.Cards.Help.Prompt,
                        url: cf.Links.Support,
                        buttonText: "Submit"
                    })]
            },
            {
                header: "Resources",
                widgets: [{
                        icon: Cardin.Icon.WEB,
                        content: cf.Strings.Cards.Help.Before2020,
                        link: {
                            url: cf.Links.SupportBeforeJan,
                            tab: true
                        }
                    },
                    {
                        icon: Cardin.Icon.WEB,
                        content: cf.Strings.Cards.Help.After2020,
                        link: {
                            url: cf.Links.SupportAfterJan,
                            tab: true
                        }
                    }]
            }]
    };
    return Cardin.card(config);
}
/**
 * @summary builds home card
 * @param {Keela} keela
 * @param {ParsedMessage} message
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function homeCard(keela, message) {
    try {
        var configs = keela.run(message);
        return Cardin.deck(configs);
    }
    catch (error) {
        console.warn("failed to build home card: ".concat(error, ", region: ").concat(keela.settings.region));
        return Cardin.handleError(error, getErrorCardConfig());
    }
}
/**
 * @summary builds contextless homepage Card
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function homepageCard() {
    try {
        var cf = getConfig();
        /** @type {CardConfig} */
        var home = {
            header: {
                image: getHouseIcon(),
                title: cf.Strings.Cards.Home.Title
            },
            sections: [{
                    widgets: [{
                            content: cf.Strings.Cards.Home.Prompt
                        }]
                }]
        };
        return Cardin.deck([home]);
    }
    catch (error) {
        console.warn("failed to build homepage card: ".concat(error));
        return Cardin.handleError(error);
    }
}
/**
 * @summary Builds settings card;
 * @param {UserSettings} settings
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function settingsCard(settings) {
    var token = settings.token, region = settings.region;
    var cf = getConfig();
    /** @type {CardConfig} */
    var card = {
        header: {
            title: cf.Strings.Settings.Title
        },
        sections: [
            makeRegionSection(cf, { region: region, builderName: buildSettings.name }),
            {
                isCollapsible: true,
                numUncollapsible: 1,
                widgets: [{
                        content: cf.Strings.Settings.Token.Prompt,
                        buttonConfig: {
                            type: Cardin.Type.TEXT_BUTTON,
                            icon: Cardin.Icon.TAB,
                            text: Cardin.Formatter.colorize(cf.Colors.Primary, cf.Strings.Settings.Token.Action),
                            link: {
                                url: region ? "https://".concat(region, ".").concat(cf.Links.Base) : cf.Links.Settings,
                                tab: true
                            }
                        }
                    },
                    {
                        change: {
                            callback: saveWithPing.name,
                            params: {
                                builderName: buildSettings.name
                            },
                            spinner: true
                        },
                        name: "token",
                        content: token,
                        title: cf.Strings.Settings.Token.Label,
                        hint: cf.Strings.Settings.Token.Example
                    }]
            },
            {
                header: "Manage",
                widgets: [{
                        icon: "CLOCK",
                        title: "Last updated",
                        content: settings.localeTimestamp
                    },
                    {
                        icon: Cardin.Icon.RESET,
                        content: "Reset all settings",
                        click: {
                            callback: "reset"
                        }
                    }]
            }
        ]
    };
    return Cardin.card(card);
}
/**
 * @summary makes a region section
 * @param {ReturnType<getConfig>} cf
 * @param {{
 *  builderName ?: string,
 *  page ?: number,
 *  region ?: "usa"|"can"|"aus"|"ca",
 *  ping ?: boolean
 * }}
 */
var makeRegionSection = function (cf, _a) {
    if (cf === void 0) { cf = getConfig(); }
    var _b = _a === void 0 ? {} : _a, _c = _b.region, region = _c === void 0 ? "usa" : _c, builderName = _b.builderName, _d = _b.ping, ping = _d === void 0 ? false : _d, page = _b.page;
    var options = [
        { text: "Australia", value: "aus" },
        { text: "Canada", value: "can" },
        { text: "USA", value: "usa" }
    ];
    if (region === "ca")
        region = "can"; //fixup for region change
    options.forEach(function (option) { return option.selected = (option.value === region); });
    var actionParams = {
        notify: cf.Strings.Notifications.Save.RegionSuccess,
    };
    if (builderName !== void 0) {
        actionParams.builderName = builderName;
    }
    if (page !== void 0) {
        actionParams.page = page;
    }
    var action = {
        callback: (ping ? saveWithPing : builderName ? foregroundSave : backgroundSave).name,
        params: actionParams,
        spinner: true
    };
    return {
        widgets: [{
                content: cf.Strings.Cards.Region.Prompt
            }, {
                type: Cardin.Type.DROPDOWN,
                name: "region",
                content: options,
                change: action,
                spaceAfter: true
            }]
    };
};
/**
 * @summary builds region card
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function regionCard() {
    var cf = getConfig();
    var settingSection = makeRegionSection(cf);
    settingSection.widgets.push({
        icon: Cardin.Icon.FORWARD,
        content: Cardin.Formatter.format({
            text: cf.Strings.FTE.Finish.Action,
            color: cf.Colors.Primary,
            bold: true
        }),
        click: {
            callback: 'onMessageOpen'
        }
    });
    var region = {
        header: {
            image: getWebIcon(),
            title: cf.Strings.Cards.Region.Title
        },
        sections: [settingSection]
    };
    return Cardin.card(region);
}
/**
 * @summary Builds welcome card;
 * @returns {GoogleAppsScript.Card_Service.Card}
 */
function welcomeCard() {
    var cf = getConfig();
    var welcome = {
        header: {
            image: getKeelaIcon(),
            title: cf.Strings.FTE.Title
        },
        sections: [{
                widgets: [{
                        content: cf.Strings.FTE.Welcome,
                        spaceBefore: true
                    },
                    {
                        icon: Cardin.Icon.TASK,
                        content: cf.Strings.FTE.Tasks.Highlights
                    },
                    {
                        icon: Cardin.Icon.TASK,
                        content: cf.Strings.FTE.Tasks.Transactions
                    },
                    {
                        icon: Cardin.Icon.FORWARD,
                        content: Cardin.Formatter.format({
                            text: cf.Strings.FTE.Action,
                            color: cf.Colors.Primary,
                            bold: true
                        }),
                        spaceBefore: true,
                        click: {
                            callback: buildFTE.name,
                            params: { page: 1 }
                        }
                    }]
            }]
    };
    return Cardin.card(welcome);
}
/**
 * @summary gets a task list widget config
 * @param {...string} tasks task names
 * @returns {Array<{
 *  icon    : string,
 *  content : string
 * }>}
 */
var getTaskListConfig = function () {
    var tasks = [];
    for (var _i = 0; _i < arguments.length; _i++) {
        tasks[_i] = arguments[_i];
    }
    return tasks.map(function (line) { return ({
        icon: Cardin.Icon.TASK,
        content: line
    }); });
};
/**
 * @summary gets a support widget config
 * @param {{
 *  text       ?: string,
 *  tab        ?: boolean,
 *  url        ?: string,
 *  callback   ?: string,
 *  buttonText ?: string
 * }}
 */
var getSupportWidgetConfg = function (_a) {
    var _b = _a === void 0 ? {} : _a, _c = _b.text, text = _c === void 0 ? "Please contact support" : _c, url = _b.url, _d = _b.callback, callback = _d === void 0 ? "buildHelp" : _d, _e = _b.buttonText, buttonText = _e === void 0 ? "Get Help" : _e, _f = _b.tab, tab = _f === void 0 ? true : _f;
    var cf = getConfig();
    var config = {
        content: text,
        buttonConfig: {
            type: Cardin.Type.TEXT_BUTTON,
            icon: Cardin.Icon.TAB,
            text: Cardin.Formatter.colorize(cf.Colors.Primary, buttonText)
        }
    };
    var buttonConfig = config.buttonConfig;
    if (url) {
        buttonConfig.link = { url: url, tab: tab };
        return config;
    }
    buttonConfig.click = { callback: callback };
    return config;
};
/**
 * @summary general error card template
 * @param {object} [cf] add-on configuration
 * @returns {CardConfig}
 */
var getErrorCardConfig = function (cf) {
    if (cf === void 0) { cf = getConfig(); }
    return {
        header: {
            image: Cardin.Icon.WARNING,
            title: cf.Strings.Cards.Error.Title
        },
        sections: [
            {
                widgets: [
                    {
                        content: cf.Strings.Cards.Error.Reason.Long
                    },
                    getSupportWidgetConfg({
                        text: cf.Strings.Cards.Help.Prompt,
                        url: cf.Links.Support,
                        buttonText: "Submit"
                    })
                ]
            }
        ]
    };
};
/**
 * @summary checks if value is falsy or empty string
 * @param {undefined|null|""} [val] possibly falsy value
 * @returns {boolean}
 */
var isFalsyOrEmptyStr = function (val) { return val === void 0 || val === null || val === ""; };
/**
 * @summary defaults props to specified value if not found
 * @param {(Object.<string, any>|any[])} obj object to default
 * @param  {Object.<string, any>|string[]} props props to default
 * @param {any} [globalDefault] shared default value
 * @returns {object}
 */
var defaultProps = function (obj, props, globalDefault) {
    var pArr = Array.isArray(props);
    var output = Object.assign({}, obj);
    var hasGlobalDefault = globalDefault !== void 0;
    Object.entries(props).forEach(function (_a) {
        var _b = __read(_a, 2), name = _b[0], defaultOrName = _b[1];
        var propName = pArr ? defaultOrName : name;
        if (obj.hasOwnProperty(propName)) {
            output[propName] = obj[propName];
            return;
        }
        if (pArr) {
            output[propName] = globalDefault;
            return;
        }
        output[name] = defaultOrName === void 0 && hasGlobalDefault ? globalDefault : defaultOrName;
    });
    return output;
};
/**
 * @summary parses object properties
 * @param {object} obj object to parse
 * @returns {object}
 */
var propsFromString = function (obj) {
    var output = {};
    Object.entries(obj).forEach(function (_a) {
        var _b = __read(_a, 2), k = _b[0], v = _b[1];
        try {
            output[k] = JSON.parse(v);
        }
        catch (error) {
            output[k] = v;
        }
    });
    return output;
};
/**
 * @summary extracts event object params
 * @param {EventObject} e add-on event object
 * @returns {object}
 */
function getParameters(e) {
    var _a = e.commonEventObject, commonEventObject = _a === void 0 ? {} : _a;
    return propsFromString(commonEventObject.parameters || {});
}
/**
 * @summary formInputs parser
 * @param {EventObject} e add-on event object
 * @returns {Record<string, string[]>}
 */
function getInputValues(e) {
    var commonEventObject = e.commonEventObject;
    var formInputs = commonEventObject.formInputs;
    var temp = {};
    for (var key in formInputs) {
        var inputWrapper = formInputs[key];
        var dateInput = inputWrapper.dateInput, dateTimeInput = inputWrapper.dateTimeInput, stringInputs = inputWrapper.stringInputs, timeInput = inputWrapper.timeInput;
        var inputObject = dateInput || timeInput || dateTimeInput || stringInputs;
        var value = inputObject.value;
        //TODO: expand parser if needed
        temp[key] = value;
    }
    return temp;
}
/**
 * @summary overrides empty string props
 * @param {object} tgt target object
 * @param {object} src source object
 * @param {boolean} [missingAsEmpty] whether to set missing props
 * @returns {object}
 */
var assignToEmpty = function (tgt, src, missingAsEmpty) {
    if (missingAsEmpty === void 0) { missingAsEmpty = true; }
    var output = __assign({}, tgt);
    Object.keys(src).forEach(function (key) {
        if (tgt[key] === "" || missingAsEmpty && !(src.hasOwnProperty(key))) {
            output[key] = src[key];
        }
    });
    return output;
};
/**
 * @summary checks which environment the add-on is running in
 * @returns {boolean}
 */
var isDev = function () {
    try {
        var email = Session.getEffectiveUser().getEmail();
        return /@cardinsoft/.test(email);
    }
    catch (error) {
        console.warn(error);
        return false;
    }
};
/**
 * @template {unknown} T
 *
 * @summary gets last element of the array
 * @param {T[]} arr array to lookup
 * @returns {T|undefined}
 */
var last = function (arr) { return arr[arr.length - 1]; };
